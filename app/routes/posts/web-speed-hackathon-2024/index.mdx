---
title: Web Speed Hackathon 2024にこっそり参加したら2位になりました
date: 2024-03-26T22:30:00+09:00
description: TODO
categories:
  - 開発
tags:
  - React
  - Vite
  - CyberAgent
---

こんにちは、[@p1ass](https://twitter.com/p1ass)です。

先日、こっそり Web Speed Hackathon 2024 に参加していました。

<ExLinkCard url="https://cyberagent.connpass.com/event/300386/" />

元々、イベントに参加する予定はなく、connpass の登録もしていなかったですが、当日余裕があったのでこっそり GitHub から参加登録して挑戦していました。

当日の競技終了時点での順位は 10 位以下だったのですが、上位の多くが FAIL したため、最終順位で 2 位を取ることができました 👏

ただ、こっそり参加していたため、運営さんにはイレギュラーな形で入賞者向けの連絡をしていただくことになってしまい、その節はご迷惑をおかけしました 🙏

今回は、せっかく入賞したので、Web Speed Hackathon 2024 でチューニングした内容を簡単にまとめてみます。
当日のリポジトリはこちらです。

<ExLinkCard url="https://github.com/p1ass/web-speed-hackathon-2024" />

{/* <!--more--> */}

## チューニング内容

### SQLite のテーブルにインデックスを貼る

僕はバックエンド・インフラ領域が主戦場で、フロントエンドについては趣味でしか触っていません。
そこで、「せっかくならバックエンドのコードから直すか」ということでバックエンドから改善していくことにしました。

開発環境を準備し、ぱっとコードを見たところデータベースのインデックスが貼られていないことに気づきました。
貼っておいて損はないだろう、ということで、インデックスを追加しました。

### API の呼び出し回数の最適化

開発環境で Web ページを開くと無駄に API リクエストが飛んでいる様子が見て取れました。
よく見ると、クライアント・サーバー間で N+1 問題が発生していました。

各要素ごとに API を叩くのではなく、一括で取得した値を React の Props として渡すことで、不必要に API を叩かないようにしました。

### アセットの配信時に Cache-Control ヘッダーをつけるようにする

今回、サーバーは Hono を使って書かれていたのですが、そのミドルウェアで、Cache-Control を `no-store` にしていました。
アセットや画像はキャッシュされて問題ないので、URL を見てキャッシュして良い場合はキャッシュするようにしました。

### Web フォントの読み込みを直す

index.html で Noto Sans JP を読み込んでいるのですが、どこでも使われていなさそうだったので削除しました。

### 意味もなく canvas を使っている部分をやめる

UI を見るとただ画像を表示しているだけなのに、なぜか canvas を使って描画している箇所があったので、素直に `<img href={url}>` で表示するようにしました。

### 画像の WebP 化 & 適切ななサイズに事前リサイズ

今回の実装では、クエリパラメーターで指定されたサイズに画像をリサイズして返す実装が用意されていました。
しかし、画像のリアルタイム変換は CPU 負荷もメモリ負荷も高いので、事前に必要な画像を作成し、その画像を返すようにしました。

ついでにファイル形式を WebP(非可逆圧縮)にしました。

### ヒーロー画像が意味もなく data url 形式で埋め込まれいたので、普通の画像として扱う

ヒーロー画像が data url として TypeScript のコードに埋め込まれていました。
加えて、それをなぜか Three.js を使って画像をレンダリングしていました。

Three.js のコードが長々書かれていたのですが、こんなことをする必要はないので、あまり読まず全部削除して、普通の画像として表示させるようにしました。

### なぜか zstd を使って圧縮をしていたのでやめる

わざわざ Service Worker を使ってまで、zstd 形式でサーバーからのデータを圧縮していました。
CPU やメモリの小さいインスタンスを使っているので、圧縮のためにデータを毎回メモリに載せるのはよろしくないので、そのコードを全部消しました。

### クライアントのバンドルを Vite に移行する

このあたりから、ちゃんとフロントエンドの最適化と向き合っていかないといけないと感じ始めました。

手始めに、Suspense と lazy を使ってチャンクの分割を試みようとしたのですが、元々の実装である tsup ではできないことがわかりました。

そこで、クライアントのバンドルのみ Vite に移行し、チャンク分割をできるようにしました。

この移行が曲者で、Buffer のポリフィルが必要だっだりして、かなりの時間を溶かしました。
最終的には以下のような `vite.confg.ts` でビルドするようになりました。

### 利用規約とかを lazy で読み込む

利用規約のテキストがバカでかく、これが `index.js` に含まれちゃっているのが微妙でした。

サーバーから API で返すか lazy で読み込むか悩んだのですが、Vite 移行によって簡単にチャンク分割ができるようになったので、後者のやり方で対応しました。

### '@mui/icons-material' を Named Export で読み込む

必要なファイルだけバンドルされるようにアイコンを Named Export で読み込むようにしました。

### 内部遷移を React Router の Link でやるようにする

元々、a タグを使ってナビゲーションしていたのですが、クライアント側でやっても良くね？と思い、React Router の Link を使うようにしました。
これが正しかったのかはいまいち分かっていません。

### jitter を消す

サーバーの負荷を軽減するという名目で 500ms 以上の jitter が差さっていたのですが、これまでの改善でサーバーの負荷はかなり下がっていたので、削除しました。

### いらないライブラリを消す

バンドルサイズがでかいライブラリ群を消して、素直な実装に置き換えました。
消したのは、以下のライブラリたちです。

- moment-timezone
- magika
- unicode なんとか

### 検索画面でユーザーの入力を少し待つようにする

ユーザーが 1 文字打つたびに API リクエストが飛んでいたので、数百 ms 待ってから API リクエストするようにしました。

### 世界の変化についていく必要はない

漫画ビューワーで世界の変化についていくために 2 \*\* 12 回のループが回っていたのですが、そんなに世界の変化に追従する必要はないので、ループ回数を減らしました。

### ログイン画面の正規表現をやめる

ログイン画面の正規表現がクソ重いものになっていました。
ユーザー向けのメッセージを見る限り、単純な判定しかしなくて良さそうだったので、シンプルな実装に変更しました。

### CLS の改善を試みようとするが諦める

CLS のスコアを上げるために、スケルトンを追加したり頑張っていたのですが、時間もあまり無く、やる気も失ったので、数カ所だけ改善して、作業を終えることにしました。

### 結果

最終スコアは次の通りです。

テスト項目 スコア
[App] ホームを開く 70.35 / 100.00
[App] 作者詳細を開く 74.10 / 100.00
[App] 作品詳細を開く 64.15 / 100.00
[App] エピソード詳細を開く 25.10 / 100.00
[App] 作品を検索する 25.75 / 50.00
[App] 漫画をスクロールして読む 50.00 / 50.00
[App] 利用規約を開く 50.00 / 50.00
[Admin] ログインする 49.25 / 50.00
[Admin] 作品の情報を編集する 0.75 / 50.00
[Admin] 作品に新しいエピソードを追加する 24.25 / 50.00
合計 433.70 / 700.00
（暫定 12 位）

## 感想

### ISUCON と違って、無駄に複雑化しているものをシンプルな実装に戻すことが多かった

ISUCON では、「シンプルに実装すると重くなっちゃうよね、さあどう工夫しようか？」と悩むことが多いと感じています。

一方で今回の問題は、「悪意を持って無駄に複雑になっているコードを読み解いて本当の意図を理解し、どう簡単に 実装できるか」という観点で問題に取り組んでいました。

ISUCON とは逆のメンタルモデルで問題を解いている気分になり、新鮮だな〜と感じました。

## 終わりに

Web Speed Hackathon 2024 にこっそり参加しましたが、想像以上に楽しくことができました。
運営の方々本当にありがとうございました！
